<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JWT dispenser</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css"
      integrity="sha256-h/qtq9bUnXbOOwP4EcbLtYM9Mk3iQQcHZAZ+Jz5y0WQ="
      crossorigin="anonymous"
    />

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js"
      integrity="sha256-gOkV4d9/FmMNEkjOzVlyM2eNAWSUXisT+1RbMTTIgXI="
      crossorigin="anonymous"
      async
      defer
    ></script>
  </head>
  <body>
    <div class="container py-4" style="max-width: 720px" x-data="{}">
      <h1>JWT dispenser</h1>
      <p class="lead">
        This little tool generates Google-signed JWTs which you can use to
        protect your API endpoints.
      </p>
      <hr />
      <div class="card">
        <div class="card-header">Generate a JWT</div>
        <div class="card-body">
          <div x-show="$store.nojwt">
            <div class="d-flex">
              <div
                id="g_id_onload"
                data-client_id="413915959575-0i3lqth0o4b07k6v7e1ssar6kg4n52uk.apps.googleusercontent.com"
                data-context="use"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false"
              ></div>
              <div
                class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="filled_blue"
                data-text="continue_with"
                data-size="large"
                data-logo_alignment="left"
              ></div>
            </div>
          </div>
          <div x-show="$store.jwt">
            <div class="input-group mb-3">
              <button
                class="btn btn-outline-secondary"
                type="button"
                x-on:click="$store.copy()"
              >
                Copy
              </button>
              <input
                type="text"
                id="jwt"
                class="form-control"
                placeholder=""
                readonly
                x-bind:value="$store.jwt"
              />
            </div>
            <p class="mb-0">
              <strong>Important:</strong> Do not give this JWT to anyone or any
              system that you do not trust.
            </p>
          </div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-header">How to use the JWT</div>
        <div class="card-body">
          <p>
            The JWTs generated by this tool are
            <a
              href="https://developers.google.com/identity/gsi/web/guides/verify-google-id-token"
              >cryptographically signed by Google</a
            >
            and can be verified using
            <a href="https://www.googleapis.com/oauth2/v3/certs"
              >Google’s JSON Web Key Set</a
            >.
          </p>

          <p>
            In Node.js, you can use the
            <a href="https://www.npmjs.com/package/jose">jose</a> package to
            verify the JWT.
          </p>

          <pre><code class="language-javascript" style="font-family: var(--bs-font-monospace); font-size: .875em;">import { createRemoteJWKSet, jwtVerify } from 'jose'

const issuer = 'https://accounts.google.com'
const keySetUrl = new URL('https://www.googleapis.com/oauth2/v3/certs')
const audience = '413915959575-0i3lqth0o4b07k6v7e1ssar6kg4n52uk.apps.googleusercontent.com'
const keySet = createRemoteJWKSet(keySetUrl)
function validate(jwt) {
  return jwtVerify(jwt, keySet, { issuer, audience })
}

const result = await validate('eyJhb.....')
console.log(result)
</code></pre>
          <p>
            Once the JWT’s authenticity has been verified, you can protect your
            endpoints by checking
            <code>result.payload.email</code> against your allowlist.
          </p>
        </div>
      </div>
    </div>

    <script>
      function handleCredentialResponse(response) {
        Alpine.store('nojwt', false)
        Alpine.store('jwt', response.credential)
      }
      document.addEventListener('alpine:init', () => {
        Alpine.store('nojwt', true)
        Alpine.store('jwt', '')
        Alpine.store('copy', () => {
          const input = document.querySelector('#jwt')
          input.focus()
          input.select()
          document.execCommand('copy')
        })
      })
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"
      integrity="sha256-S5mU/F9EHUxP/yPe4lNcCQEL+TsdkMLHKwQww9PxAI4="
      crossorigin="anonymous"
    ></script>
  </body>
</html>
