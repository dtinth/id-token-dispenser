<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JWT dispenser</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css"
      integrity="sha256-h/qtq9bUnXbOOwP4EcbLtYM9Mk3iQQcHZAZ+Jz5y0WQ="
      crossorigin="anonymous"
    />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <div class="container py-4" style="max-width: 720px" x-data="{}">
      <h1>JWT dispenser</h1>
      <p class="lead">
        This little tool generates Google-signed JWTs which you can use to
        protect your API endpoints.
      </p>
      <hr />
      <div class="card">
        <div class="card-header">Generate a JWT</div>
        <div class="card-body">
          <div x-show="$store.nojwt">
            <div class="d-flex">
              <div
                id="g_id_onload"
                data-client_id="413915959575-0i3lqth0o4b07k6v7e1ssar6kg4n52uk.apps.googleusercontent.com"
                data-context="use"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false"
              ></div>
              <div
                class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="filled_blue"
                data-text="continue_with"
                data-size="large"
                data-logo_alignment="left"
              ></div>
            </div>
          </div>
          <div x-show="$store.jwt">
            <div class="input-group mb-3">
              <span class="input-group-text">ID token</span>
              <input
                type="text"
                id="jwt"
                class="form-control"
                placeholder=""
                readonly
                x-bind:value="$store.jwt"
                style="
                  font-family: var(--bs-font-monospace);
                  font-size: 0.875em;
                "
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                x-on:click="$store.copy()"
              >
                Copy
              </button>
            </div>
            <p class="mb-0">
              <strong>Only send this JWT to your own systems.</strong> Do not
              send this JWT to anyone or any system that you do not trust. Do
              not display the JWT in public until it is expired. Anyone with
              access to this JWT can impersonate you throughout the token’s
              lifespan. This JWT expires
              <span x-text="$store.expiry"></span> after issuance. Once it
              expires, you must get a new token.
            </p>
          </div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-header">How to use the JWT</div>
        <div class="card-body">
          <p>
            The JWTs generated by this tool are
            <a
              href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken"
              >OpenID Connect ID tokens</a
            >
            that are
            <a
              href="https://developers.google.com/identity/gsi/web/guides/verify-google-id-token"
              >cryptographically signed by Google</a
            >. They can be verified using
            <a href="https://www.googleapis.com/oauth2/v3/certs"
              >Google’s JSON Web Key Set</a
            >.
          </p>

          <p>
            In Node.js, you can use the
            <a href="https://www.npmjs.com/package/jose">jose</a> package to
            verify the JWT.
          </p>

          <pre><code class="language-javascript" style="font-family: var(--bs-font-monospace); font-size: .875em;">import { createRemoteJWKSet, jwtVerify } from 'jose'

const issuer = 'https://accounts.google.com'
const keySetUrl = new URL('https://www.googleapis.com/oauth2/v3/certs')
const audience = '413915959575-0i3lqth0o4b07k6v7e1ssar6kg4n52uk.apps.googleusercontent.com'
const keySet = createRemoteJWKSet(keySetUrl)
function validate(jwt) {
  return jwtVerify(jwt, keySet, { issuer, audience })
}

const result = await validate('eyJhb.....')
console.log(result)
</code></pre>
          <p>
            Once the JWT’s authenticity has been verified, you can protect your
            endpoints by checking
            <code>result.payload.email</code> against your allowlist.
          </p>
        </div>
      </div>
      <footer class="text-muted pt-3">
        <hr />
        Built by <a href="https://dt.in.th/" class="text-muted">@dtinth</a>.
        Source code on
        <a href="https://github.com/dtinth/jwt-dispenser" class="text-muted"
          >GitHub</a
        >.
      </footer>
    </div>

    <script>
      function handleCredentialResponse(response) {
        Alpine.store('nojwt', false)
        Alpine.store('jwt', response.credential)
        const parts = response.credential.split('.')
        const payload = JSON.parse(atob(parts[1]))
        Alpine.store(
          'expiry',
          Math.round((payload.exp - payload.iat) / 60) + ' minutes',
        )
        document.dispatchEvent(new CustomEvent('jwt-dispenser:generated'))
      }
      document.addEventListener('alpine:init', () => {
        Alpine.store('nojwt', true)
        Alpine.store('jwt', '')
        Alpine.store('expiry', '…')
        Alpine.store('copy', () => {
          const input = document.querySelector('#jwt')
          input.focus()
          input.select()
          document.execCommand('copy')
          document.dispatchEvent(new CustomEvent('jwt-dispenser:copied'))
        })
      })
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.3/dist/cdn.min.js"
      integrity="sha256-gOkV4d9/FmMNEkjOzVlyM2eNAWSUXisT+1RbMTTIgXI="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"
      integrity="sha256-S5mU/F9EHUxP/yPe4lNcCQEL+TsdkMLHKwQww9PxAI4="
      crossorigin="anonymous"
    ></script>
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.9.3/firebase-app.js'
      import {
        getAnalytics,
        logEvent,
      } from 'https://www.gstatic.com/firebasejs/9.9.3/firebase-analytics.js'
      const firebaseConfig = {
        apiKey: 'AIzaSyBNQKLgU4d4Z4B47_s3XYMM-DFe7LEbTeE',
        authDomain: 'jwt-dispenser.firebaseapp.com',
        projectId: 'jwt-dispenser',
        storageBucket: 'jwt-dispenser.appspot.com',
        messagingSenderId: '413915959575',
        appId: '1:413915959575:web:9add49b16d7fd30645e752',
        measurementId: 'G-YW3GJF3XK6',
      }
      const app = initializeApp(firebaseConfig)
      const analytics = getAnalytics(app)
      document.addEventListener('jwt-dispenser:generated', () => {
        logEvent(analytics, 'jwt_generated')
      })
      document.addEventListener('jwt-dispenser:copied', () => {
        logEvent(analytics, 'jwt_copied')
      })
    </script>
  </body>
</html>
